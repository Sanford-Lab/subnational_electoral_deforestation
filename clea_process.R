library(tidyverse)

load("../data/clea/clea_lc_20201216.rdata")

#Competitiveness Measure I
closeness_i <- function(vec){
    return((1 - (sort(vec, decreasing = TRUE)[1] - sort(vec, decreasing = TRUE)[2]))*100)
}

clea_final <- clea_lc_20201216 %>%
    group_by(ctr, cst, yr) %>%
    mutate(pvs1 = replace(pvs1,pvs1<0,NA))

fixes <- c(1171,1410,1411,1785,1235,1236,1237,1238,1239,1240,
           1241,1242,1243,1244,1245,1246,1449,1450,1451,452,
           1616,1617,1875)

pvs_fix <- clea_final %>% 
    filter(id %in% fixes) %>% 
    group_by(id,cst) %>% 
    mutate(pvs1 = (pv1/sum(pv1)))

clea_final <- clea_final %>% filter(!(id %in% fixes))
clea_final <- bind_rows(clea_final,pvs_fix) %>% 
    mutate(comp_i = round(closeness_i(pvs1),2)) %>% 
    distinct(id, cst, .keep_all = TRUE) %>%
    select(release,id,rg,ctr_n,ctr,yr,mn,sub,cst_n,cst,mag,comp_i)

#Subset to only GRED-valid observations (We will hardcode remove Sweden, US, Brazil invalid years below)
#Valid IDs ----
valid_ids <- c(1619,1683,1016,719,720,721,722,723,724,725,1018,1019,1132,1351,1352,1687,1361,81,82,83,84,85,86,1138,
               894,895,147,1152,1153,1156,1157,1841,1369,7,8,9,10,11,12,13,14,15,16,17,18,19,1163,1372,1531,1532,1533,
               1534,1843,1167,1168,1169,1373,1374,1780,20,970,1377,1378,1379,1380,1537,1383,1384,1385,1386,1387,1388,
               1389,157,158,159,1172,1702,22,23,24,25,26,27,28,1028,1029,1030,1031,1032,1033,1034,1391,1846,160,1538,
               1539,1706,1707,1781,1174,1175,1540,1541,1795,1796,1797,1798,165,166,1392,1393,1782,1038,1394,37,1542,1184,
               1185,1186,1187,1188,1189,1190,1544,1191,1192,1620,268,311,312,1039,1040,1041,1402,1849,1201,1202,1203,1204,
               1852,905,906,907,908,909,1207,1208,1209,1210,1211,1718,913,914,915,1583,1584,916,917,918,919,920,921,922,
               1410,1411,1785,363,364,365,366,367,368,369,370,371,372,373,1412,1429,1430,374,1431,1432,1433,1045,809,810,
               811,812,813,814,815,816,817,818,819,920,821,822,823,824,825,826,1046,1586,1854,1855,1856,415,416,1435,1436,
               1437,1438,1786,1214,1215,1628,1723,1724,1725,1226,1227,1228,1229,1230,1231,1232,1233,1234,1235,1236,1237,1238,1239,1240,
               1241,1242,1243,1244,1245,1246,464,465,466,467,468,469,470,471,472,473,474,475,476,477,478,479,480,1250,1453,
               1252,1253,1254,1789,483,484,485,486,487,488,1050,1051,1255,1256,1257,1258,1259,1734,1735,1864,1647,
               1648,1649,1650,1651,1652,1653,1654,1655,1656,1055,1060,1267,538,539,540,541,542,543,544,545,546,547,548,549,
               550,989,990,991,1492,1791,1269,1270,1493,1660,1819,1067,1068,996,1495,1496,552,553,554,555,556,557,558,559,
               997,998,999,1069,1070,1670,53,54,55,56,1071,943,944,945,946,947,948,949,950,951,1598,1599,1000,1001,1002,
               1003,1746,1747,1867,1289,1290,1291,1749,1750,570,1605,1606,1607,1608,1609,1610,1611,1612,1613,1614,1821,1822,
               1823,1824,1825,1826,1827,1828,1873,571,572,573,574,575,576,577,1074,1075,1076,1077,1674,1675,960,961,962,
               963,964,965,1759,1321,1322,1323,1761,578,579,580,581,582,583,584,585,586,587,588,589,590,591,592,593,594,595,
               596,597,598,599,600,601,602,603,604,605,606,1006,1007,1079,1080,1081,1082,1083,1084,1085,1086,1087,1088,
               1089,1090,1091,1501,1502,1874,882,883,884,885,1326,1327,1328,1329,1330,1331,1332,1615,1829,1830,1831,
               1832,1833,1880,1881,1882,652,653,654,655,656,657,658,659,660,661,662,663,664,665,666,667,668,669,670,671,
               672,673,674,675,676,677,678,679,680,681,682,683,684,685,686,687,688,689,690,691,692,693,694,695,696,697,
               698,699,700,701,702,703,704,705,706,707,708,709,710,711,712,713,714,1103,1104,1105,1106,1107,1108,1109,1110,
               1520,1774,1887,1888,1102,1336,1337,1338,1339,1340,1341,1342,1343,1344,1345,1346,1523,61)

load("../data/processed/gred_yr.Rdata")

clea_final <- clea_final %>% 
    filter((id %in% valid_ids),!(ctr==752 & yr<1952),!(ctr==840 & yr<1900)) %>% 
    left_join(gred_yr) %>%
    mutate(GRED_yr=ifelse(is.na(GRED_yr),yr,GRED_yr)) %>%
    left_join(clea_nat)

#Clean Up ----
rm(clea_lc_20201216,pvs_fix)

#Incumbent == winner:
incumbents <- clea_lc_20220908 %>%
    group_by(ctr, cst, yr) %>%
    mutate(winner = pty_n[which.max(pvs1)]) %>%
    distinct(ctr, cst, yr, .keep_all = TRUE) %>%
    arrange(yr, .by_group = TRUE) %>%
    group_by(ctr,cst) %>%
    mutate(incumbent = dplyr::lag(winner), incumb_reelec = ifelse(winner == incumbent,1,0)) %>%
    ungroup() %>%
    select(id,cst,winner,incumbent,incumb_reelec)

#Incumbent party vote share:
incumbent_pvs <- clea_lc_20220908 %>% 
    left_join(incumbents,by=c("id","cst")) %>%
    filter(pty_n == incumbent) %>%
    mutate(winner_pvs = pvs1) %>%
    select(id,cst,pvs1)

#save(clea_final,file="../data/processed/clea_final.RData")

